close all;
clear all;
clc;

epsilon                = 0.018;
Table_Testing_Complete = load_data_eps_test(epsilon);

t  = Table_Testing_Complete.Time(1,:);
dt = t(2);

theta_0 = 3.912;
alpha   = 0.019308;
n       = 100;
p_end   = 1/2;
p_lims  = 0.03;

p = p_end-p_lims:0.001:p_end+p_lims;
v = -0.2:0.001:0.2;

for i = 1:length(p)
    for j = 1:length(v)
                
        P_dot        = (p_end-p(i)) / dt;
        Theta_t      = theta_t(theta_0, alpha, p(i), P_dot);
        Theta_t_next = theta_t(theta_0, alpha, p_end, 0);
        
        Exp_V   = moment_1(v(j),theta_0,alpha,Theta_t,Theta_t_next,p(i),p_end,dt,n);
        Exp_V_2 = moment_2(v(j),theta_0,Theta_t,Theta_t_next,p(i),p_end,alpha,Exp_V,dt,n);
                
        for k = 1:100
            sim_path_v(k)   = sde_FE_error(v(j),alpha,theta_0,Theta_t,dt,p(i));
            sim_path_v_2(k) = sde_FE_error_2(v(j)^2,alpha,theta_0,Theta_t,dt,p(i));
        end
        
        Exp_V_emp   = mean(sim_path_v);
        Exp_V_emp_2 = mean(sim_path_v_2);

        exp_v_ode(i,j)   = Exp_V(end);
        exp_v_2_ode(i,j) = Exp_V_2(end);
        exp_v_emp(i,j)   = Exp_V_emp;
        exp_v_emp_2(i,j) = Exp_V_emp_2;
        
    end
end

error_v   = abs(exp_v_ode-exp_v_emp);
error_v_2 = abs(exp_v_2_ode-exp_v_emp_2);

figure;
[V,Y] = meshgrid(p-p_end,v);
surf(V,Y,exp_v_emp');
title('$E[V]$ Empirical','interpreter','latex');
xlabel('Prev. Rel. Forecast'); ylabel('Prev. Error (V)');

figure;
surf(V,Y,exp_v_ode');
title('$E[V]$ ODE','interpreter','latex');
xlabel('Prev. Rel. Forecast'); ylabel('Prev. Error (V)');

figure;
contourf(V,Y,error_v'); colorbar;
title('$E[V]$ Abs-error Empirical-ODE','interpreter','latex');
xlabel('Prev. Rel. Forecast'); ylabel('Prev. Error (V)');

figure;
surf(V,Y,exp_v_emp_2');
title('$E[V^2]$ Empirical','interpreter','latex');
xlabel('Prev. Rel. Forecast'); ylabel('Prev. Error (V)');

figure;
surf(V,Y,exp_v_2_ode');
title('$E[V^2]$ ODE','interpreter','latex');
xlabel('Prev. Rel. Forecast'); ylabel('Prev. Error (V)');

figure;
contourf(V,Y,error_v_2',10); colorbar;
title('$E[V^2]$ Abs-error Empirical-ODE','interpreter','latex');
xlabel('Prev. Rel. Forecast'); ylabel('Prev. Error (V)');

%% Now we plot w.r.t. p_end:

p_end = 0.2:0.1:0.8;

for l = 1:length(p_end)
    
    p = p_end(l)-p_lims:0.001:p_end(l)+p_lims;
    disp(['Completed: ',num2str(l/length(p_end)*100),'%']);

    for i = 1:length(p)
        for j = 1:length(v)

            v_toUse = 
            
            P_dot        = (p_end(l)-p(i)) / dt;
            Theta_t      = theta_t(theta_0, alpha, p(i), P_dot);
            Theta_t_next = theta_t(theta_0, alpha, p_end(l), 0);

            Exp_V   = moment_1(v(j),theta_0,alpha,Theta_t,Theta_t_next,p(i),p_end(l),dt,n);
            Exp_V_2 = moment_2(v(j),theta_0,Theta_t,Theta_t_next,p(i),p_end(l),alpha,Exp_V,dt,n);

            for k = 1:100
                sim_path_v(k)   = sde_FE_error(v(j),alpha,theta_0,Theta_t,dt,p(i));
                sim_path_v_2(k) = sde_FE_error_2(v(j)^2,alpha,theta_0,Theta_t,dt,p(i));
            end

            Exp_V_emp   = mean(sim_path_v);
            Exp_V_emp_2 = mean(sim_path_v_2);

            exp_v_ode(i,j)   = Exp_V(end);
            exp_v_2_ode(i,j) = Exp_V_2(end);
            exp_v_emp(i,j)   = Exp_V_emp;
            exp_v_emp_2(i,j) = Exp_V_emp_2;

        end
    end

    error_v(l)   = mean(mean(abs(exp_v_ode-exp_v_emp)));
    error_v_2(l) = mean(mean(abs(exp_v_2_ode-exp_v_emp_2)));
    
end

figure;
plot(p_end,error_v);